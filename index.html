<html>
<head>
	<title>xAPI Dashboard</title>
	<link rel='stylesheet' href='lib/nv.d3.css'></link>
	<script type="text/javascript" src="dist/xapicollection.min.js"></script>
	<script type="text/javascript" src="dist/xapidashboard.min.js"></script>
	
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
	
	<script src="extra/gen-lrs-data.js"></script>
</head>
<body ng-app="ebookDash">
	<style>
		.nv-axislabel {
			font-size: 18px;
		}
		html, body, #main{
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}
		#sidebar{
			float: left;
			width: 10%;
			height: 100%;
			background: #f8f8f8;
			padding: 5px 0 0 5px;
		}
		#children{
			float: right;
			width: 85%;
			padding: 5px;
		}	
		.svg-container{
			width: 50%;
			height: 50%;
			float:right;
		}
		.heading{
			font-size: 30px;
		}
	</style>
	<div id="main">
		<div id="sidebar" ng-controller="sidebar">			
			<span ng-show="parents.length > 0">Parents</span>
			<ul>
				<li ng-repeat="item in parents">
					<a href="" ng-click="filterClick(item, 'parent')">{{item}}</a>
				</li>
			</ul>	
			
			<span ng-show="groups.length > 0">Groups</span>
			<ul>
				<li ng-repeat="item in groups">
					<a href="" ng-click="filterClick(item, 'grouping')">{{item}}</a>
				</li>
			</ul>
			
			<div ng-show="header.grouping || header.parent">
				<span>Filters</span>
				<ul>
					<li ng-show="header.parent">Parent: <br/>{{header.parent}}</li>
					<li ng-show="header.grouping">Grouping: <br/>{{header.grouping}}</li>
				</ul>
			</div>
		</div>
	
		<div id="children">			
			<div class="svg-container"><svg id="svg"></svg></div>
			<div class="svg-container"><svg id="svg4"></svg></div>
		</div>
	</div>
	<script type="text/javascript">
		var dashModule = angular.module("ebookDash", []);
		
		dashModule.factory('chartFilter', function(){
			return {filter:{grouping: '', parent: ''}, data:{grouping: [], parents: []}};
		});		
		
		dashModule.factory('updateChartFilters', ['chartFilter', function(chartFilter){
			return function(){
				var groupingArr = chartFilter.data.grouping;
				var parentArr = chartFilter.data.parents;
				
				window.statements.forEach(function(element){
					var grouping = null;
					var parents = null;
					
					try{ grouping = element.context.contextActivities.grouping; }
					catch(e){}			
					
					try{ parents = element.context.contextActivities.parent; }
					catch(e){}
					
					if(grouping != null && grouping.length > 0){
						grouping.forEach(function(item){
							var str = item.definition.name["en-US"];
							if(groupingArr.indexOf(str) == -1) groupingArr.push(str);
						});
					}		
					
					if(parents != null && parents.length > 0){
						parents.forEach(function(item){
							var str = item.definition.name["en-US"];
							if(parentArr.indexOf(str) == -1) parentArr.push(str);
						});
					}
				});
			};
		}]);
		
		dashModule.controller('sidebar', ['$scope', 'chartFilter', 'updateChartFilters', function($scope, chartFilter, updateChartFilters){
			$scope.parents = chartFilter.data.parents;
			$scope.groups = chartFilter.data.grouping;
			$scope.header = chartFilter.filter;
			
			$scope.filterClick = function(val, type){
				
				chartFilter.filter[type] = val;
				
				
				var addCondition = 'context.contextActivities.' + type + '.*.definition.name.en-US = ' + "'" + val + "'";
				minMaxAverage.opts.pre = addCondition; // "verb.id = 'http://adlnet.gov/expapi/verbs/answered' and " + addCondition;
				console.log(minMaxAverage.opts.pre);
				
				minMaxAverage.draw();
				updateChartFilters();
			};
			
			updateChartFilters();
		}]);
	
		var wrapper = new XAPIWrapper({"endpoint" : 'https://lrs.adlnet.gov/xAPI/'});
		var dash = new ADL.XAPIDashboard('#svg');
		
		dash.addStatements(window.statements);

		var minMaxAverage = dash.createMultiBarChart({
			pre: "verb.id = 'http://adlnet.gov/expapi/verbs/answered'",
			aggregate: ADL.multiAggregate("actor.mbox", ADL.count),
			groupBy: 'actor.mbox',
			innerGroupBy: 'object.id',
			customize: function(nvd3Chart){
				nvd3Chart.yAxis.axisLabel("Grade");			
			}
		});

		var studentsInRange = dash.createBarChart({
			container: "#svg4",
			groupBy: 'actor.mbox',
			aggregate: ADL.count(),
			customize: function(nvd3Chart, event){
				nvd3Chart.xAxis.rotateLabels(45).axisLabel("Student");
				nvd3Chart.yAxis.axisLabel("Grade");
			}
		});

		minMaxAverage.draw();	
		studentsInRange.draw();
	</script>
</body>
</html>
